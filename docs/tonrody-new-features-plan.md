# План реализации новых функций TONRODY

## 1. Подготовительные шаги

1. **Анализ текущей архитектуры**
   - Изучить существующие маршруты React и точки расширения навигации.
   - Определить актуальные общие компоненты (GlassContainer, CosmicBackground, меню, провайдеры тем).
2. **Проверка зависимостей**
   - Убедиться, что подключены `@tonconnect/ui-react`, `i18next`, Chakra UI и поддержка Telegram WebApp (`telegram-web-app.js`).
   - Проверить актуальность `tonconnect-manifest.json`, `twaReturnUrl` и разрешений.
3. **Настройка локализации**
   - Добавить структуру `public/locales/{ru,en}.json` и инициализацию i18next в `src/main.tsx`.
   - Реализовать сохранение выбранного языка в `localStorage` и чтение языка из `Telegram.WebApp.initDataUnsafe.user.language_code`.

## 2. Создание лобби

1. **Компонент `LobbyCreateForm`**
   - Разместить в `src/components/lobby/LobbyCreateForm.tsx`.
   - Использовать Chakra UI `Modal`/`Drawer` + форму (`FormControl`, `Input`, `Select`, `NumberInput`).
   - Поля: название (обязательное), сложность (`RadioGroup`), пароль (опционально), максимальное число игроков (`NumberInput` с валидацией диапазона).
2. **Бизнес-логика**
   - Вынести логику отправки запросов в хук `useLobbyActions` (`src/hooks/useLobbyActions.ts`).
   - При отправке POST `/lobbies/create` отправлять `title`, `difficulty`, `password` (если задан), `maxPlayers`, `creatorId` из `initDataUnsafe.user.id`.
3. **Обратная связь**
   - Использовать `useToast` для сообщений об успехе/ошибке.
   - Кнопка «Создать» в состоянии `isLoading` во время запроса.
4. **Интеграция**
   - Добавить кнопку «Создать лобби» в существующий экран списка (см. ниже) либо в шапку.
   - Реализовать закрытие модалки и обновление списка через контекст/глобальный стор.

## 3. Список лобби

1. **Компонент `LobbyList`**
   - Разместить в `src/components/lobby/LobbyList.tsx`.
   - Запрос списка лобби через `GET /lobbies` в `useEffect`, состояние хранить в `useLobbyStore` (zustand/recoil) или `useQuery`.
2. **Карточка `LobbyCard`**
   - Создать в `src/components/lobby/LobbyCard.tsx`, использовать `GlassContainer` и стили неонового стола.
   - Отображать: название, сложность, индикатор приватности, ставка, пул, время создания, список участников (`AvatarGroup`), счетчик мест `occupied/max`.
3. **Адаптивность**
   - Desktop: `SimpleGrid` с `minChildWidth` ≈ 320px.
   - Mobile: одна колонка, кнопка join видна сразу.
4. **Обновление данных**
   - Реализовать polling (например, 15 c.) или WebSocket подписку.
   - После успешного создания лобби обновлять список вручную или оптимистично добавлять карточку.

## 4. Присоединение к лобби

1. **UI**
   - В `LobbyCard` добавить кнопку «Join» (`Button` или вся карточка кликабельна) и отображать статус «Вы в лобби» для текущего пользователя.
2. **Пароль**
   - Для приватных лобби открывать `Modal`/`AlertDialog` с вводом пароля.
3. **Запрос**
   - POST `/lobbies/{id}/join` с `userId` и паролем.
   - Обрабатывать ошибки (неверный пароль, лобби заполнено, игра активна) через toast.
4. **Навигация**
   - После успеха переходить на страницу `LobbyRoom` (`/lobby/:id`), где отображается состав игроков и кнопка старта.
   - Отмечать присоединенные лобби в состоянии, чтобы отключать кнопку join.

## 5. Приглашение по ссылке

1. **Генерация**
   - В `LobbyRoom` добавить кнопку «Пригласить».
   - Получать стартовый параметр от сервера (API `/lobbies/{id}/invite-link`) или формировать локально `https://t.me/<BotName>?start=lobby_<id>[_token]`.
2. **Шаринг**
   - Использовать `navigator.clipboard.writeText` и/или `Telegram.WebApp.openTelegramLink`.
3. **Автоподключение**
   - В `App.tsx` проверять `Telegram.WebApp.initDataUnsafe.start_param` или query-параметры.
   - При наличии `lobbyId`/`token` выполнять автоматический join (или показывать форму пароля) и перенаправлять в `LobbyRoom`.

## 6. Интеграция TON

1. **TonConnect провайдер**
   - Обернуть приложение в `TonConnectUIProvider` (в `src/main.tsx`), указав `manifestUrl` и `actionsConfiguration.twaReturnUrl`.
2. **Компонент `TonWalletControls`**
   - Разместить в `src/components/wallet/TonWalletControls.tsx`.
   - Содержит `TonConnectButton`, а также кнопки «Депозит» и «Вывести» (доступны только при подключенном кошельке).
3. **Депозит/Вывод**
   - Реализовать модалки с вводом суммы, вызывать `tonConnect.sendTransaction` с адресом игрового контракта.
   - При успехе обновлять баланс пользователя (через запрос к бэкенду или контракту).
4. **Баланс**
   - В `LobbyRoom` и главном экране отображать текущий баланс TON.

## 7. Раздел «История»

1. **Маршрут `/history`**
   - Создать компонент `HistoryPage` (`src/pages/HistoryPage.tsx`).
   - Загружать данные `GET /users/{id}/history` и выводить список/таблицу игр (дата, результат, изменение баланса).
2. **UI**
   - Использовать `GlassContainer`, `Table` или `Stack` с градиентными акцентами.
3. **Навигация**
   - Добавить пункт меню/кнопку в хедере или боковом меню.
   - Обеспечить мультиязычные подписи и адаптивность (на мобильном выводить карточки).

## 8. Мультиязычность

1. **Структура переводов**
   - Ключи: `lobby.create.title`, `lobby.join.button`, `wallet.deposit`, `history.title` и т.д.
   - Добавить проверку на заполненность переводов в CI (опционально).
2. **Переключатель языка**
   - Компонент `LanguageSwitcher` в шапке: `Menu` с RU/EN, сохранять выбор в `localStorage`.
3. **Telegram интеграция**
   - При первом запуске устанавливать язык = `Telegram.WebApp.initDataUnsafe.user.language_code` (если поддерживается).

## 9. Адаптивность и стили

1. **Адаптивные пропсы Chakra**
   - Использовать массивы и объекты breakpoints для размеров карточек, шрифтов, отступов.
2. **Flex/Grid**
   - Все новые макеты строить на `Flex`, `Stack`, `SimpleGrid`; избегать фиксированных ширин.
3. **Safe Area**
   - Применить `paddingBottom` с `env(safe-area-inset-bottom)` для страниц, где есть нижние панели.
4. **Neon/Glass стилистика**
   - Использовать существующий `GlassContainer`, `boxShadow`, градиентные фоны и неоновые тени для кнопок.
5. **Анимации**
   - Применить `framer-motion` для появления модалок, карточек и подсветки кнопок.

## 10. Тестирование и архивирование

1. **Юнит/интеграционные тесты**
   - Добавить тесты для ключевых хуков и компонентов (например, `useLobbyActions`, `LobbyCreateForm`).
   - Использовать `vitest`/`react-testing-library`.
2. **E2E**
   - Настроить тесты (Playwright) для сценариев создания и присоединения к лобби, переключения языка, TonConnect.
3. **Регрессионные проверки**
   - Проверить, что существующий функционал не затронут (Smoke-тесты).
4. **Сборка и архивирование**
   - После прохождения тестов выполнить `pnpm build` для фронтенда, собрать артефакты и подготовить архив релиза.
   - Архив включить в пайплайн CI/CD или предоставить отдельным артефактом (например, `zip` папки `dist`).

## 11. Риски и контроль качества

1. **API синхронизация**
   - Согласовать контракты REST/WebSocket с backend-командой (формат DTO для лобби, истории, баланса).
2. **Безопасность**
   - Проверить валидацию паролей на клиенте и сервере, подпись Telegram initData, обработку TonConnect ошибок.
3. **Перфоманс**
   - Оптимизировать загрузку списков (lazy загрузка аватаров, мемоизация списков).
4. **Документация**
   - Обновить README/вики с инструкциями по запуску Mini App, настройке TON и локализации.

## 12. План поэтапного внедрения

1. **Этап 1:** Инфраструктура (i18n, TonConnect provider, глобальные контексты, стор лобби).
2. **Этап 2:** Список лобби + создание лобби (UI + API интеграция).
3. **Этап 3:** Присоединение/приглашения + страница лобби.
4. **Этап 4:** Wallet controls (депозит/вывод) и обновление балансов.
5. **Этап 5:** История игр и дополнительные UI (языковой переключатель, адаптивность).
6. **Этап 6:** Тестирование, отладка, сборка, документация, подготовка архива.

``
